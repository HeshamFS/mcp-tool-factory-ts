/**
 * Auto-generated MCP server: {{serverName}}
 * Generated by MCP Tool Factory
 */

import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import { z } from 'zod';

{{#if productionImports}}
{{{productionImports}}}
{{/if}}

{{#each dependencyImports}}
{{{this}}}
{{/each}}

{{#each extractedImports}}
{{{this}}}
{{/each}}

// ============== SERVER SETUP ==============

const server = new McpServer({
  name: '{{serverName}}',
  version: '1.0.0',
});

{{#if authEnvVars.length}}
// ============== AUTH CONFIGURATION ==============
// These environment variables are required for API access

const AUTH_CONFIG: Record<string, string | undefined> = {
{{#each authEnvVars}}
  '{{this}}': process.env['{{this}}'],
{{/each}}
};

function getAuth(key: string): string | undefined {
  return AUTH_CONFIG[key];
}

function requireAuth(key: string): string {
  const value = getAuth(key);
  if (!value) {
    throw new Error(`Missing required environment variable: ${key}`);
  }
  return value;
}

{{/if}}

{{#if productionLogging}}
{{{productionLogging}}}
{{/if}}

{{#if productionMetrics}}
{{{productionMetrics}}}
{{/if}}

{{#if productionRateLimiting}}
{{{productionRateLimiting}}}
{{/if}}

{{#if productionRetry}}
{{{productionRetry}}}
{{/if}}

{{#if includeHealthCheck}}
// ============== HEALTH CHECK ==============

server.tool(
  'health_check',
  'Check server health and configuration status',
  {},
  async () => {
    const result: Record<string, unknown> = {
      status: 'healthy',
      server: '{{serverName}}',
      timestamp: new Date().toISOString(),
      tools_available: {{toolCount}},
    };

{{#if authEnvVars.length}}
    // Check auth configuration
    const authStatus: Record<string, string> = {};
{{#each authEnvVars}}
    authStatus['{{this}}'] = getAuth('{{this}}') ? 'configured' : 'MISSING';
{{/each}}
    result['auth_config'] = authStatus;

    // Mark unhealthy if any auth is missing
    if (Object.values(authStatus).includes('MISSING')) {
      result['status'] = 'unhealthy';
      result['error'] = 'Missing required authentication';
    }
{{/if}}

    return { content: [{ type: 'text', text: JSON.stringify(result) }] };
  }
);

{{/if}}

// ============== TOOLS ==============

{{#each toolSpecs}}
server.tool(
  '{{this.name}}',
  '{{this.description}}',
  {
{{#each this.inputSchema.properties}}
    {{@key}}: z.{{jsonTypeToZod this.type}}(){{#if this.description}}.describe('{{this.description}}'){{/if}}{{#unless (isRequired @key ../this.inputSchema.required)}}.optional(){{/unless}},
{{/each}}
  },
  async (params) => {
    try {
{{{lookup ../implementations this.name}}}
    } catch (e) {
      return {
        content: [{
          type: 'text',
          text: JSON.stringify({ error: e instanceof Error ? e.message : String(e) })
        }]
      };
    }
  }
);

{{/each}}

// ============== MAIN ==============

async function main(): Promise<void> {
{{#if authEnvVars.length}}
  // Check for required auth on startup
  const missingAuth = Object.entries(AUTH_CONFIG)
    .filter(([_, v]) => !v)
    .map(([k]) => k);
  if (missingAuth.length > 0) {
    console.warn(`WARNING: Missing environment variables: ${missingAuth.join(', ')}`);
  }

{{/if}}
  const transport = new StdioServerTransport();
  await server.connect(transport);
}

main().catch(console.error);
